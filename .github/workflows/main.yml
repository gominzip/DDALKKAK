name: Create branch & open PR on issue creation

on:
  issues:
    types: [opened]          # ì´ìŠˆê°€ ì—´ë¦´ ë•Œë§ˆë‹¤ ì‹¤í–‰

# [í•„ìˆ˜ ìˆ˜ì • â‘ ] í‘¸ì‹œÂ·PR ì‘ì„±ì„ ìœ„í•´ write ê¶Œí•œ ëª…ì‹œ
permissions:
  contents: write
  pull-requests: write

jobs:
  create-branch-and-pr:
    runs-on: ubuntu-latest

    steps:
      # --- ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ ---
      - name: Check out repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0       # ì „ì²´ íˆìŠ¤í† ë¦¬ í™•ë³´

      # --- jq ì„¤ì¹˜ ---
      - name: Install jq
        run: sudo apt-get -qq update && sudo apt-get -qq install -y jq

      # --- ë¸Œëœì¹˜ ìƒì„± ---
      - name: Set up variables and create branch
        id: create_branch
        run: |
          # ===== ê¸°ë³¸ ì„¤ì • =====
          BASE_BRANCH="main"
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"

          # ===== ë¼ë²¨ ì¶”ì¶œ =====
          LABELS=$(jq -r '.issue.labels[].name' "$GITHUB_EVENT_PATH")

          # ===== ë¼ë²¨ í”Œë˜ê·¸ =====
          HAS_FE=false
          HAS_BE=false
          while IFS= read -r label; do
            case "$label" in
              fe) HAS_FE=true ;;
              be) HAS_BE=true ;;
            esac
          done <<< "$LABELS"

          # ===== ìœ íš¨ì„± ê²€ì‚¬ =====
          if $HAS_FE && $HAS_BE; then
            echo "::error ::'fe'ì™€ 'be' ë¼ë²¨ì„ ë™ì‹œì— ë‹¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•˜ì‹­ì‹œì˜¤."
            exit 1
          elif ! $HAS_FE && ! $HAS_BE; then
            echo "::error ::'fe' ë˜ëŠ” 'be' ë¼ë²¨ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¼ë²¨ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”."
            exit 1
          fi

          # ===== í”„ë¦¬í”½ìŠ¤ ê²°ì • =====
          if $HAS_FE; then
            PREFIX="feat/fe"
          else
            PREFIX="feat/be"
          fi

          # ===== ë¸Œëœì¹˜ ìƒì„± =====
          BRANCH_NAME="${PREFIX}/${ISSUE_NUMBER}"
          echo "BRANCH_NAME=$BRANCH_NAME" >> "$GITHUB_OUTPUT"   # ë‹¤ìŒ stepì—ì„œ ì‚¬ìš©
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME" "origin/$BASE_BRANCH"
          git push origin "$BRANCH_NAME"

      # --- Pull Request ìë™ ìƒì„± ---
      - name: Create pull request
        env:
          GH_TOKEN: ${{ github.token }}   # gh CLI ì¸ì¦
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.BRANCH_NAME }}"
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"
          PR_TITLE="[ìë™] ${ISSUE_TITLE}"

          PR_BODY=$(cat <<EOF
## ğŸ“ PR ê°œìš”

<!-- ì´ PRì´ ì–´ë–¤ ë‚´ìš©ì¸ì§€ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš” -->

## ğŸ” ë³€ê²½ ì‚¬í•­

<!-- ì´ PRì—ì„œ ë³€ê²½ëœ ë‚´ìš©ì„ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš” -->

- [ ] ë³€ê²½ ì‚¬í•­ 1
- [ ] ë³€ê²½ ì‚¬í•­ 2
- [ ] ë³€ê²½ ì‚¬í•­ 3

## ğŸ§ª í…ŒìŠ¤íŠ¸

<!-- í…ŒìŠ¤íŠ¸í•œ ë‚´ìš©ì„ ì„¤ëª…í•´ì£¼ì„¸ìš” -->

- [ ] í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 1
- [ ] í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 2

## ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·

<!-- UI ë³€ê²½ì´ ìˆëŠ” ê²½ìš°, ìŠ¤í¬ë¦°ìƒ·ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš” -->

## ğŸ”— ê´€ë ¨ ì´ìŠˆ

<!-- ê´€ë ¨ëœ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” -->

Closes #${ISSUE_NUMBER}

## ğŸ“ ì¶”ê°€ ì„¤ëª…

<!-- ì¶”ê°€ë¡œ ì„¤ëª…ì´ í•„ìš”í•œ ì‚¬í•­ì´ ìˆë‹¤ë©´ ì‘ì„±í•´ì£¼ì„¸ìš” -->
EOF
)

          # gh CLIê°€ ì—†ìœ¼ë©´ ì„¤ì¹˜
          if ! command -v gh &> /dev/null; then
            sudo apt-get -qq update && sudo apt-get -qq install -y gh
          fi

          # --- ì¤‘ë³µ PR ë°©ì§€ ë¡œì§ ---
          if gh pr view "$BRANCH_NAME" --json number &>/dev/null; then
            echo "PR already exists for branch '$BRANCH_NAME'. Skipping creation."
            exit 0
          fi
          # -------------------------

          gh pr create \
            --title "$PR_TITLE" \
            --body  "$PR_BODY" \
            --base  "main" \
            --head  "$BRANCH_NAME"

            
